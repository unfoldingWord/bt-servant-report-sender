<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BT Servant Usage Report</title>
    {% if not inline_styles %}
    <link rel="stylesheet" href="report.css">
    {% else %}
    <style>
        body { font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #2d5078; border-bottom: 2px solid #2d5078; padding-bottom: 10px; }
        h2 { color: #2d5078; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f5f5f5; }
        .metric { display: inline-block; margin: 10px 20px 10px 0; }
        .metric-value { font-size: 24px; font-weight: bold; color: #2d5078; }
        .metric-label { font-size: 12px; color: #666; }
    </style>
    {% endif %}
</head>
<body>
    <header class="report-header">
        <h1 class="report-title">BT Servant Usage Report</h1>
        <p class="report-subtitle">
            {{ report.executive_summary.date_range_start.strftime('%B %d, %Y') }}
            to
            {{ report.executive_summary.date_range_end.strftime('%B %d, %Y') }}
        </p>
        <p class="report-generated">
            Generated: {{ report.generated_at.strftime('%Y-%m-%d %H:%M UTC') }}
        </p>
    </header>

    <!-- Executive Summary -->
    <section class="section">
        <h2 class="section-title">Executive Summary</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <p class="metric-value">{{ report.executive_summary.total_interactions }}</p>
                <p class="metric-label">Total Interactions</p>
            </div>
            <div class="metric-card">
                <p class="metric-value">${{ "%.4f"|format(report.executive_summary.total_cost_usd) }}</p>
                <p class="metric-label">Total Cost</p>
            </div>
            <div class="metric-card">
                <p class="metric-value">{{ "%.1f"|format(report.executive_summary.avg_response_time_ms / 1000) }}s</p>
                <p class="metric-label">Avg Response Time</p>
            </div>
            <div class="metric-card">
                <p class="metric-value">{{ report.executive_summary.unique_users }}</p>
                <p class="metric-label">Unique Users</p>
            </div>
        </div>
    </section>

    <!-- Cost Analysis -->
    <section class="section">
        <h2 class="section-title">Cost Analysis</h2>

        <div class="cost-summary">
            <span class="cost-total">Total: ${{ "%.4f"|format(report.cost_breakdown.total_cost_usd) }}</span>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Cost Type</th>
                    <th class="text-right">Amount (USD)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Input Tokens</td>
                    <td class="text-right">${{ "%.4f"|format(report.cost_breakdown.total_input_cost_usd) }}</td>
                </tr>
                <tr>
                    <td>Output Tokens</td>
                    <td class="text-right">${{ "%.4f"|format(report.cost_breakdown.total_output_cost_usd) }}</td>
                </tr>
            </tbody>
        </table>

        {% if report.cost_by_intent %}
        <h3>Cost by Intent</h3>
        <table>
            <thead>
                <tr>
                    <th>Intent</th>
                    <th class="text-right">Count</th>
                    <th class="text-right">Total Cost</th>
                    <th class="text-right">Avg Cost</th>
                </tr>
            </thead>
            <tbody>
                {% for intent in report.cost_by_intent[:10] %}
                <tr>
                    <td>{{ intent.intent_name }}</td>
                    <td class="text-right">{{ intent.interaction_count }}</td>
                    <td class="text-right">${{ "%.4f"|format(intent.total_cost_usd) }}</td>
                    <td class="text-right">${{ "%.4f"|format(intent.avg_cost_per_interaction) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </section>

    <!-- Performance Metrics -->
    <section class="section">
        <h2 class="section-title">Performance Metrics</h2>

        <div class="perf-stats">
            <div class="perf-stat">
                <p class="perf-stat-value">{{ "%.1f"|format(report.performance.avg_response_time_ms / 1000) }}s</p>
                <p class="perf-stat-label">Average</p>
            </div>
            <div class="perf-stat">
                <p class="perf-stat-value">{{ "%.1f"|format(report.performance.p50_response_time_ms / 1000) }}s</p>
                <p class="perf-stat-label">P50</p>
            </div>
            <div class="perf-stat">
                <p class="perf-stat-value">{{ "%.1f"|format(report.performance.p95_response_time_ms / 1000) }}s</p>
                <p class="perf-stat-label">P95</p>
            </div>
            <div class="perf-stat">
                <p class="perf-stat-value">{{ "%.1f"|format(report.performance.p99_response_time_ms / 1000) }}s</p>
                <p class="perf-stat-label">P99</p>
            </div>
        </div>

        {% if report.performance.slowest_spans %}
        <h3>Slowest Processing Spans</h3>
        <table>
            <thead>
                <tr>
                    <th>Span Name</th>
                    <th class="text-right">Avg Duration</th>
                </tr>
            </thead>
            <tbody>
                {% for span_name, duration in report.performance.slowest_spans %}
                <tr>
                    <td>{{ span_name }}</td>
                    <td class="text-right">{{ "%.1f"|format(duration / 1000) }}s</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </section>

    <!-- Usage Analytics -->
    <section class="section">
        <h2 class="section-title">Usage Analytics</h2>

        <p><strong>Unique Users:</strong> {{ report.usage.unique_users }}</p>

        {% if report.usage.top_intents %}
        <h3>Top Intents</h3>
        <table>
            <thead>
                <tr>
                    <th>Intent</th>
                    <th class="text-right">Count</th>
                </tr>
            </thead>
            <tbody>
                {% for intent_name, count in report.usage.top_intents %}
                <tr>
                    <td>{{ intent_name }}</td>
                    <td class="text-right">{{ count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if report.usage.language_distribution %}
        <h3>Language Distribution</h3>
        <table>
            <thead>
                <tr>
                    <th>Language</th>
                    <th class="text-right">Count</th>
                </tr>
            </thead>
            <tbody>
                {% for lang, count in report.usage.language_distribution.items() %}
                <tr>
                    <td>{{ lang }}</td>
                    <td class="text-right">{{ count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </section>

    <!-- System Health -->
    <section class="section">
        <h2 class="section-title">System Health</h2>

        <p>
            <strong>Success Rate:</strong>
            <span class="health-indicator {% if report.system_health.success_rate_percent >= 99 %}health-good{% elif report.system_health.success_rate_percent >= 95 %}health-warning{% else %}health-critical{% endif %}">
                {{ "%.2f"|format(report.system_health.success_rate_percent) }}%
            </span>
        </p>

        <table>
            <tbody>
                <tr>
                    <td>Warnings</td>
                    <td class="text-right">{{ report.system_health.warning_count }}</td>
                </tr>
                <tr>
                    <td>Errors</td>
                    <td class="text-right">{{ report.system_health.error_count }}</td>
                </tr>
            </tbody>
        </table>

        {% if report.system_health.error_messages %}
        <h3>Recent Errors</h3>
        <ul class="warning-list">
            {% for error in report.system_health.error_messages %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if report.system_health.warning_messages %}
        <h3>Recent Warnings</h3>
        <ul class="warning-list">
            {% for warning in report.system_health.warning_messages %}
            <li>{{ warning }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </section>

    <footer class="report-footer">
        <p>Generated by bt-servant-report-sender</p>
    </footer>
</body>
</html>
